mout1 <- matchit(treat ~ age + educ + black + hispan + nodegree + married + re74 + re75, method = "nearest", data=lalonde)
mout2 <- matchit(treat ~ age + educ + black + hispan + nodegree + married + re74 + re75, method = "nearest", data=lalonde, discard = "control")
mout3 <- matchit(treat ~ age+I(age^2) + educ + I(educ^2) + black + hispan + nodegree + married + re74 + re75 + I(re74==0) + I(re75==0) + educ:re74 + I(age^3), method = "nearest", data=lalonde, discard = "control")
mout1
185*2
mout2
mout3
attributes(mout3)
mout3$match.matrix
table(mout3$match.matrix)
mout3 <- matchit(treat ~ age+I(age^2) + educ + I(educ^2) + black + hispan + nodegree + married + re74 + re75 + I(re74==0) + I(re75==0) + educ:re74 + I(age^3), method = "nearest", data=lalonde, discard = "control",replace=TRUE)
table(mout3$match.matrix)
attributes(mout3)
mout3
66+185
mout3$match.matrix
class(mout3$match.matrix)
dim(mout3$match.matrix)
lalonde[rownames(lalonde) %in% mout$match.matrix,1]
lalonde[rownames(lalonde) %in% mout3$match.matrix,1]
lalonde[rownames(lalonde) %in% mout3$match.matrix,2]
newdata <- rbind(lalonde[1:185,],lalonde[rownames(lalonde) %in% mout3$match.matrix,])
mout3$weights
lm(re78~., data= newdata, weights = mout3$weights)
dat <- cbind(lalonde, mout3$weights)
colnames(dat)
colnames(dat)[11] <- "weights"
colnames(dat)
newdata <- rbind(lalonde[1:185,],lalonde[rownames(lalonde) %in% mout3$match.matrix,])
lm(re78~., data= newdata, weights = newdata$weights)
mout3 <- matchit(treat ~ age+I(age^2) + educ + I(educ^2) + black + hispan + nodegree + married + re74 + re75 + I(re74==0) + I(re75==0) + educ:re74 + I(age^3), method = "nearest", data=lalonde, discard = "control",replace=TRUE, m.order = "random")
dat <- cbind(lalonde, mout3$weights)
newdata <- rbind(lalonde[1:185,],lalonde[rownames(lalonde) %in% mout3$match.matrix,])
lm(re78~., data= newdata, weights = newdata$weights)
########### Sept 18, 2014
########### Propensity scoring from Dehejia & Wahba (1999)
setwd("~Kellie/Documents/ModelMatch/Data/")
options(scipen=100)
########### Table 1: verify the mean characteristics match for each dataset
fin <- c("nsw_treated_lalonde", "nsw_control_lalonde", "nswre74_treated",
"nswre74_control","psid_controls","psid2_controls",
"psid3_controls", "cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic', 'Married',
'Nodegree', 'RE74', 'RE75', 'RE78')
for (file in fin){
dat <- read.table(paste(file, ".txt", sep=""), header = F)
if (ncol(dat) == length(headers)){
colnames(dat) <- headers
}else{colnames(dat) <- headers[-8]}
print(file)
print(apply(dat[,-1], 2, mean))
}
########### Table 2 Panel A: Lalonde's earning comparisons using his original sample
nswtr <- read.table("nsw_treated_lalonde.txt", header=F)
colnames(nswtr) <- headers[-8]
fin <- c("nsw_control_lalonde","psid_controls","psid2_controls",
"psid3_controls", "cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic', 'Married',
'Nodegree', 'RE74', 'RE75', 'RE78')
cat(c('file', 'unadj', 'adj', 'diff_unadj', 'diff_adj', 'adj_all_covariates', "\n"), sep = "\t")
for (file in fin){
dat <- read.table(paste(file, ".txt", sep=""), header = F)
if (ncol(dat) == length(headers)){
colnames(dat) <- headers
dat <- dat[,-8]
}else{colnames(dat) <- headers[-8]}
unadj <- mean(nswtr$RE78) - mean(dat$RE78)
combine <- rbind(dat, nswtr)
adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic,
data = combine)$coeff[2]
diff_unadj <- lm(RE78~Treated+RE75, data=combine)$coeff[2]
diff_adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black +
Hispanic + RE75, data=combine)$coeff[2]
adj_all <- lm(RE78~, data=combine)$coeff[2]
cat(c(file, unadj, adj, diff_unadj, diff_adj, adj_all, "\n"), sep = "\t")
}
# The final column doesn't match
########### Table 2 Panel B: Earning comparisons using the DW sample, NOT including RE74 as a covariate
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("nswre74_control","psid_controls","psid2_controls",
"psid3_controls", "cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic', 'Married',
'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr <- nswtr[,-8]
for (file in fin){
dat <- read.table(paste(file, ".txt", sep=""), header = F)
colnames(dat) <- headers
dat <- dat[,-8]
unadj <- mean(nswtr$RE78) - mean(dat$RE78)
combine <- rbind(dat, nswtr)
adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic,
data = combine)$coeff[2]
diff_unadj <- lm(RE78~Treated+RE75, data=combine)$coeff[2]
diff_adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black +
Hispanic + RE75, data=combine)$coeff[2]
adj_all <- lm(RE78~., data=combine)$coeff[2]
cat(c(file, unadj, adj, diff_unadj, diff_adj, adj_all, "\n"), sep = "\t")
}
# The final column doesn't match
########### Table 2 Panel C: Earning comparisons using the DW sample, including RE74 as a covariate
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("nswre74_control","psid_controls","psid2_controls",
"psid3_controls", "cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic', 'Married',
'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
for (file in fin){
dat <- read.table(paste(file, ".txt", sep=""), header = F)
colnames(dat) <- headers
unadj <- mean(nswtr$RE78) - mean(dat$RE78)
combine <- rbind(dat, nswtr)
adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74,
data = combine)$coeff[2]
diff_unadj <- lm(RE78~Treated+RE75, data=combine)$coeff[2]
diff_adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black +
Hispanic + RE74 +RE75, data=combine)$coeff[2]
adj_all <- lm(RE78~., data=combine)$coeff[2]
cat(c(file, unadj, adj, diff_unadj, diff_adj, adj_all, "\n"), sep = "\t")
}
# The final column doesn't match
########### Figure 1: Estimated p(X_i) for NSW treated units and PSID comparison units
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +U74*Black"
nswtr <- read.table("nswre74_treated.txt", header=F)
psid <- read.table("psid_controls.txt", header=F)
combine <- rbind(nswtr, psid)
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic', 'Married',
'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(combine) <- headers
combine$U74 <- combine$RE74==0
combine$U75 <- combine$RE75==0
combine$pscore <- glm(model1, data = combine, family = binomial(logit))$fitted
#combine$pscore <- glm(Treated~Age+Education+Black+Hispanic+Married+Nodegree+RE74+RE75,
#                      data = combine, family = "binomial")$fitted
bounds <- c(min(combine$pscore[combine$Treated==1]), max(combine$pscore[combine$Treated==1]))
combine <- combine[combine$pscore>=bounds[1],]
hist(combine$pscore[combine$Treated == 1], col = rgb(0.1,0.1,0.1,0.5), xlab="", xlim = c(0,1),
ylim = c(0,150), main = "Estimated p(X_i), NSW and PSID", breaks=20)
counts <- hist(combine$pscore[combine$Treated == 0], col=rgb(1,1,1,0.5), add=T, breaks=20)$counts
legend("right", fill = c(rgb(0.1,0.1,0.1,0.5), "white"), legend = c("Treated","PSID"))
discarded <- nrow(psid) - sum(combine$Treated == 0)
title(xlab = paste(discarded, "comparison units discarded, first bin contains", counts[1],
"comparison units", sep = " "))
########### Figure 2: Estimated p(X_i) for NSW treated units and CPS comparison units
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74+ I(Age^3)"
nswtr <- read.table("nswre74_treated.txt", header=F)
cps <- read.table("cps_controls.txt", header=F)
combine <- rbind(nswtr, cps)
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic', 'Married',
'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(combine) <- headers
combine$U74 <- combine$RE74==0
combine$U75 <- combine$RE75==0
combine$pscore <- glm(model3, data = combine, family = binomial(logit))$fitted
#combine$pscore <- glm(Treated~Age+I(Age^2) + Education + I(Education^2) +Black+Hispanic+Married+Nodegree+RE74+RE75,
#                      data = combine, family = "binomial")$fitted
bounds <- c(min(combine$pscore[combine$Treated==1]))
combine <- combine[combine$pscore>=bounds[1],]
hist(combine$pscore[combine$Treated == 1], xlab = "", col = rgb(0.1,0.1,0.1,0.5), xlim = c(0,1),
ylim = c(0,200), main = "Estimated p(X_i), NSW and CPS", breaks=20)
counts <- hist(combine$pscore[combine$Treated == 0], col=rgb(1,1,1,0.5), add=T, breaks=20)$counts
legend("right", fill = c(rgb(0.1,0.1,0.1,0.5), "white"), legend = c("Treated","CPS"))
discarded <- nrow(cps) - sum(combine$Treated == 0)
title(xlab = paste(discarded, "comparison units discarded, first bin contains", counts[1],
"comparison units", sep = " "))
########### Table 3: NSW earnings less comparison group earnings
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("nswre74_control","psid_controls","psid2_controls",
"psid3_controls", "cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic', 'Married',
'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr$U74 <- (nswtr$RE74 == 0)
nswtr$U75 <- (nswtr$RE75 == 0)
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) + U74*Black"
model2 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) + I(RE75^2) + U74 + U75"
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74 + I(Age^3)"
selection_model <- c("", model1, model2, model2, model3, model3, model3)
for (i in 1:length(fin)){
dat <- read.table(paste(fin[i], ".txt", sep=""), header = F)
colnames(dat) <- headers
dat$U74 <- (dat$RE74 == 0)
dat$U75 <- (dat$RE75 == 0)
combine <- rbind(dat, nswtr)
#  if(i>1){
#    combine$pscore <- glm(paste(selection_model[i]), family = binomial(logit), data = combine)$fitted
#    bounds <- c(min(combine$pscore[combine$Treated==1]))#, max(combine$pscore[tr]))
#    combine <- combine[combine$pscore>=bounds[1],]# & combine$pscore<=bounds[2],]
#  }
unadj <- mean(nswtr$RE78) - mean(dat$RE78)
unadj2 <- lm(RE78~Treated, data=combine)$coeff[2] # this calculation removes controls with pscore < min for treated
adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74 + RE75,
data = combine)$coeff[2]
cat(c(fin[i], unadj, unadj2, adj, "\n"), sep = "\t")
}
# psid1, psid2, psid3, cps, cps2 don't match in 2nd column
########### Table 3: NSW treatment earnings less comparison group earnings,
########### conditional on estimated propensity score
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("psid_controls","psid2_controls","psid3_controls",
"cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic',
'Married', 'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr$U74 <- (nswtr$RE74 == 0)
nswtr$U75 <- (nswtr$RE75 == 0)
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +U74*Black"
model2 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +  I(RE75^2) + U74 + U75"
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married  + Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74+ I(Age^3)"
selection_model <- c(model1, model2, model2, model3, model3, model3)
for (nbins in seq(1,30,by=4)){
print(paste("nbins = ",nbins))
for (i in 1:length(fin)){
dat <- read.table(paste(fin[i], ".txt", sep=""), header = F)
colnames(dat) <- headers
dat$U74 <- (dat$RE74 == 0)
dat$U75 <- (dat$RE75 == 0)
combine <- rbind(nswtr, dat)
tr      <- (combine$Treated == 1)
combine$pscore <- glm(paste(selection_model[i]), family = binomial(logit), data = combine)$fitted
#  bounds <- c(min(combine$pscore[tr]), max(combine$pscore[tr]))
#  trunc <- combine[combine$pscore>=bounds[1] & combine$pscore<=bounds[2],]
bounds <- min(combine$pscore[tr])
combine <- combine[combine$pscore>=bounds[1],]
unadj <- 0; adj <- 0; quadr <- 0; ctrl <- 0
# quant <- quantile(combine$pscore, (0:nbins)/nbins)
quant <- hist(combine$pscore, breaks = nbins, plot=F)$breaks
for(q in 2:nbins+1){
stratum <- combine[combine$pscore>quant[q-1] & combine$pscore<=quant[q],]
ntreat <- sum(stratum$Treated);
if(ntreat>0 & ntreat < nrow(stratum)){
ctrl <- ctrl + sum(stratum$Treated == 0)
quadr <- quadr + (lm(RE78~(Treated + pscore)^2, data = stratum)$coeff[2])*(ntreat/sum(combine$Treated))
unadj <- unadj+(lm(RE78~Treated, data = stratum)$coeff[2])*(ntreat/sum(combine$Treated))
adj <- adj + (lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74 + RE75, data = stratum)$coeff[2])*(ntreat/sum(combine$Treated))
}
}
cat(c(fin[i], quadr, unadj, adj, ctrl, "\n"), sep = "\t")
}
}
# psid1, psid2, psid3, cps, cps2 don't match
########### Table 3: NSW treatment earnings less comparison group earnings,
########### conditional on estimated propensity score - matching on score
library(Matching)
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("psid_controls","psid2_controls","psid3_controls",
"cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic',
'Married', 'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr$U74 <- (nswtr$RE74 == 0)
nswtr$U75 <- (nswtr$RE75 == 0)
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +U74*Black"
model2 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +  I(RE75^2) + U74 + U75"
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married  + Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74+ I(Age^3)"
selection_model <- c(model1, model2, model2, model3, model3, model3)
for (i in 1:length(fin)){
dat <- read.table(paste(fin[i], ".txt", sep=""), header = F)
colnames(dat) <- headers
dat$U74 <- (dat$RE74 == 0)
dat$U75 <- (dat$RE75 == 0)
combine <- rbind(nswtr, dat)
tr      <- (combine$Treated == 1)
combine$pscore <- glm(paste(selection_model[i]), family = binomial(logit), data = combine)$fitted
bounds <- min(combine$pscore[tr])
combine <- combine[combine$pscore>=bounds[1],]
matches <- Match(Tr = combine$Treated, X = combine$pscore, replace = TRUE, exact = FALSE, M=1, ties = FALSE)
combine$weights <- combine$Treated
combine$weights[unique(matches$index.control)] <- table(matches$index.control)
nctrl <- length(unique(matches$index.control))
#  unadj <- lm(RE78~Treated, data = combine[combine$weights>0,])$coeff[2]
unadj <- mean(combine[matches$index.treated,"RE78"]-combine[matches$index.control,"RE78"])
adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74 + RE75, data = combine, weights = combine$weights)$coeff[2]
cat(c(fin[i], unadj, adj, nctrl, "\n"), sep = "\t")
}
# the results vary each time due to the random selection of matches when there are ties.
# furthermore the results are highly variable - numerical instability?
# try to translate Dehejia's code from http://economics.mit.edu/faculty/angrist/data1/mhe/dehejia
library(foreign)
cps1 <- read.dta("cps1re74.dta") # this includes both nsw treated and cps1
########### Table 3: NSW treatment earnings less comparison group earnings,
########### conditional on estimated propensity score - matching on score
library(Matching)
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("psid_controls","psid2_controls","psid3_controls",
"cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic',
'Married', 'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr$U74 <- (nswtr$RE74 == 0)
nswtr$U75 <- (nswtr$RE75 == 0)
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +U74*Black"
model2 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +  I(RE75^2) + U74 + U75"
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married  + Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74+ I(Age^3)"
selection_model <- c(model1, model2, model2, model3, model3, model3)
for (i in 1:length(fin)){
dat <- read.table(paste(fin[i], ".txt", sep=""), header = F)
colnames(dat) <- headers
dat$U74 <- (dat$RE74 == 0)
dat$U75 <- (dat$RE75 == 0)
combine <- rbind(nswtr, dat)
tr      <- (combine$Treated == 1)
combine$pscore <- glm(paste(selection_model[i]), family = binomial(logit), data = combine)$fitted
bounds <- min(combine$pscore[tr])
combine <- combine[combine$pscore>=bounds[1],]
matches <- Match(Tr = combine$Treated, X = combine$pscore, replace = TRUE, exact = FALSE, M=1, ties = FALSE)
combine$weights <- combine$Treated
combine$weights[unique(matches$index.control)] <- table(matches$index.control)
nctrl <- length(unique(matches$index.control))
#  unadj <- lm(RE78~Treated, data = combine[combine$weights>0,])$coeff[2]
unadj <- mean(combine[matches$index.treated,"RE78"]-combine[matches$index.control,"RE78"])
adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74 + RE75, data = combine, weights = combine$weights)$coeff[2]
cat(c(fin[i], unadj, adj, nctrl, "\n"), sep = "\t")
}
########### Table 3: NSW treatment earnings less comparison group earnings,
########### conditional on estimated propensity score - matching on score
library(Matching)
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("psid_controls","psid2_controls","psid3_controls",
"cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic',
'Married', 'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr$U74 <- (nswtr$RE74 == 0)
nswtr$U75 <- (nswtr$RE75 == 0)
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +U74*Black"
model2 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +  I(RE75^2) + U74 + U75"
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married  + Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74+ I(Age^3)"
selection_model <- c(model1, model2, model2, model3, model3, model3)
for (i in 1:length(fin)){
dat <- read.table(paste(fin[i], ".txt", sep=""), header = F)
colnames(dat) <- headers
dat$U74 <- (dat$RE74 == 0)
dat$U75 <- (dat$RE75 == 0)
combine <- rbind(nswtr, dat)
tr      <- (combine$Treated == 1)
combine$pscore <- glm(paste(selection_model[i]), family = binomial(logit), data = combine)$fitted
bounds <- min(combine$pscore[tr])
combine <- combine[combine$pscore>=bounds[1],]
matches <- Match(Tr = combine$Treated, X = combine$pscore, replace = TRUE, exact = FALSE, M=1, ties = FALSE)
combine$weights <- combine$Treated
combine$weights[unique(matches$index.control)] <- table(matches$index.control)
nctrl <- length(unique(matches$index.control))
#  unadj <- lm(RE78~Treated, data = combine[combine$weights>0,])$coeff[2]
unadj <- mean(combine[matches$index.treated,"RE78"]-combine[matches$index.control,"RE78"])
adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74 + RE75, data = combine, weights = combine$weights)$coeff[2]
cat(c(fin[i], unadj, adj, nctrl, "\n"), sep = "\t")
}
########### Table 3: NSW treatment earnings less comparison group earnings,
########### conditional on estimated propensity score - matching on score
library(Matching)
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("psid_controls","psid2_controls","psid3_controls",
"cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic',
'Married', 'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr$U74 <- (nswtr$RE74 == 0)
nswtr$U75 <- (nswtr$RE75 == 0)
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +U74*Black"
model2 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +  I(RE75^2) + U74 + U75"
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married  + Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74+ I(Age^3)"
selection_model <- c(model1, model2, model2, model3, model3, model3)
for (i in 1:length(fin)){
dat <- read.table(paste(fin[i], ".txt", sep=""), header = F)
colnames(dat) <- headers
dat$U74 <- (dat$RE74 == 0)
dat$U75 <- (dat$RE75 == 0)
combine <- rbind(nswtr, dat)
tr      <- (combine$Treated == 1)
combine$pscore <- glm(paste(selection_model[i]), family = binomial(logit), data = combine)$fitted
bounds <- min(combine$pscore[tr])
combine <- combine[combine$pscore>=bounds[1],]
matches <- Match(Tr = combine$Treated, X = combine$pscore, replace = TRUE, exact = FALSE, M=1, ties = FALSE)
combine$weights <- combine$Treated
combine$weights[unique(matches$index.control)] <- table(matches$index.control)
nctrl <- length(unique(matches$index.control))
#  unadj <- lm(RE78~Treated, data = combine[combine$weights>0,])$coeff[2]
unadj <- mean(combine[matches$index.treated,"RE78"]-combine[matches$index.control,"RE78"])
adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74 + RE75, data = combine, weights = combine$weights)$coeff[2]
cat(c(fin[i], unadj, adj, nctrl, "\n"), sep = "\t")
}
########### Table 3: NSW treatment earnings less comparison group earnings,
########### conditional on estimated propensity score - matching on score
library(Matching)
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("psid_controls","psid2_controls","psid3_controls",
"cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic',
'Married', 'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr$U74 <- (nswtr$RE74 == 0)
nswtr$U75 <- (nswtr$RE75 == 0)
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +U74*Black"
model2 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +  I(RE75^2) + U74 + U75"
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married  + Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74+ I(Age^3)"
selection_model <- c(model1, model2, model2, model3, model3, model3)
for (i in 1:length(fin)){
dat <- read.table(paste(fin[i], ".txt", sep=""), header = F)
colnames(dat) <- headers
dat$U74 <- (dat$RE74 == 0)
dat$U75 <- (dat$RE75 == 0)
combine <- rbind(nswtr, dat)
tr      <- (combine$Treated == 1)
combine$pscore <- glm(paste(selection_model[i]), family = binomial(logit), data = combine)$fitted
bounds <- min(combine$pscore[tr])
combine <- combine[combine$pscore>=bounds[1],]
matches <- Match(Tr = combine$Treated, X = combine$pscore, replace = TRUE, exact = FALSE, M=1, ties = FALSE)
combine$weights <- combine$Treated
combine$weights[unique(matches$index.control)] <- table(matches$index.control)
nctrl <- length(unique(matches$index.control))
#  unadj <- lm(RE78~Treated, data = combine[combine$weights>0,])$coeff[2]
unadj <- mean(combine[matches$index.treated,"RE78"]-combine[matches$index.control,"RE78"])
adj <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74 + RE75, data = combine, weights = combine$weights)$coeff[2]
cat(c(fin[i], unadj, adj, nctrl, "\n"), sep = "\t")
}
########### Table 3: NSW treatment earnings less comparison group earnings,
########### conditional on estimated propensity score - matching on score
library(Matching)
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("psid_controls","psid2_controls","psid3_controls",
"cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic',
'Married', 'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr$U74 <- (nswtr$RE74 == 0)
nswtr$U75 <- (nswtr$RE75 == 0)
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +U74*Black"
model2 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +  I(RE75^2) + U74 + U75"
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married  + Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74+ I(Age^3)"
selection_model <- c(model1, model2, model2, model3, model3, model3)
for (i in 1:length(fin)){
dat <- read.table(paste(fin[i], ".txt", sep=""), header = F)
colnames(dat) <- headers
dat$U74 <- (dat$RE74 == 0)
dat$U75 <- (dat$RE75 == 0)
combine <- rbind(nswtr, dat)
tr      <- (combine$Treated == 1)
combine$pscore <- glm(paste(selection_model[i]), family = binomial(logit), data = combine)$fitted
bounds <- min(combine$pscore[tr])
combine <- combine[combine$pscore>=bounds[1],]
matches <- Match(Tr = combine$Treated, X = combine$pscore, replace = TRUE, exact = FALSE, M=1, ties = FALSE)
combine$weights <- combine$Treated
combine$weights[unique(matches$index.control)] <- table(matches$index.control)
nctrl <- length(unique(matches$index.control))
#  unadj <- lm(RE78~Treated, data = combine[combine$weights>0,])$coeff[2]
unadj <- mean(combine[matches$index.treated,"RE78"]-combine[matches$index.control,"RE78"])
pred <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74 + RE75, data = combine, weights = combine$weights)
adj <- pred$coeff[2]
adj2 <- mean(combine[matches$index.treated,"RE78"] - pred$fitted[matches$index.treated])
cat(c(fin[i], unadj, adj, adj2, nctrl, "\n"), sep = "\t")
}
combine[matches$index.treated,"RE78"]
pred$fitted[matches$index.treated]
combine[matches$index.treated,"RE78"] - pred$fitted[matches$index.treated]
hist(pred$residuals)
plot(combine[combine$weights >0,'RE78'] pred$residuals[combine$weights>0])
plot(combine[combine$weights >0,'RE78'], pred$residuals[combine$weights>0])
plot(combine[combine$weights >0,'RE78'], pred$residuals[combine$weights>0], colors = c("red,black")[combine[combine$weights>0,"Treated"]])
plot(combine[combine$weights >0,'RE78'], pred$residuals[combine$weights>0], col= c("red,black")[combine[combine$weights>0,"Treated"]])
plot(combine[combine$weights >0,'RE78'], pred$residuals[combine$weights>0], col= c("red","black")[combine[combine$weights>0,"Treated"]])
plot(combine[combine$weights >0,'RE78'], pred$residuals[combine$weights>0], col= c("black","red")[combine[combine$weights>0,"Treated"]])
plot(combine[combine$weights >0,'RE78'], pred$residuals[combine$weights>0], col= c("black","red")[combine[combine$weights>0,"Treated"]], pch = 5)
combine
combine$Treated
combine[combine$weights>0, c("Treated","weights")]
combine[combine$weights>0, c("Treated","weights","RE78")]
cbind(combine[combine$weights>0, c("Treated","weights","RE78")], pred$fitted[combine$weights>0])
plot(combine[combine$weights>0, c("RE78")], pred$fitted[combine$weights>0])
combine[matches$index.treated,"RE78"] - pred$fitted[matches$index.treated]
mean(combine[matches$index.treated,"RE78"] - pred$fitted[matches$index.treated])
length(combine[matches$index.treated,"RE78"] - pred$fitted[matches$index.treated])
mean(pred$residuals[combine$Treated==1])
hist(1:5)
########### Table 3: NSW treatment earnings less comparison group earnings,
########### conditional on estimated propensity score - matching on score
library(Matching)
nswtr <- read.table("nswre74_treated.txt", header=F)
fin <- c("psid_controls","psid2_controls","psid3_controls",
"cps_controls","cps2_controls","cps3_controls")
headers <- c('Treated', 'Age', 'Education', 'Black', 'Hispanic',
'Married', 'Nodegree', 'RE74', 'RE75', 'RE78')
colnames(nswtr) <- headers
nswtr$U74 <- (nswtr$RE74 == 0)
nswtr$U75 <- (nswtr$RE75 == 0)
model1 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married+ Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +U74*Black"
model2 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married + Nodegree + Black + Hispanic + RE74 + RE75 + I(RE74^2) +  I(RE75^2) + U74 + U75"
model3 <- "Treated~Age + I(Age^2) + Education + I(Education^2) + Married  + Nodegree + Black + Hispanic + RE74 + RE75 + U74 + U75 + Education*RE74+ I(Age^3)"
selection_model <- c(model1, model2, model2, model3, model3, model3)
for (i in 1:length(fin)){
dat <- read.table(paste(fin[i], ".txt", sep=""), header = F)
colnames(dat) <- headers
dat$U74 <- (dat$RE74 == 0)
dat$U75 <- (dat$RE75 == 0)
combine <- rbind(nswtr, dat)
tr      <- (combine$Treated == 1)
combine$pscore <- glm(paste(selection_model[i]), family = binomial(logit), data = combine)$fitted
bounds <- min(combine$pscore[tr])
combine <- combine[combine$pscore>=bounds[1],]
matches <- Match(Tr = combine$Treated, X = combine$pscore, replace = TRUE, exact = FALSE, M=1, ties = FALSE)
combine$weights <- combine$Treated
combine$weights[unique(matches$index.control)] <- table(matches$index.control)
nctrl <- length(unique(matches$index.control))
#  unadj <- lm(RE78~Treated, data = combine[combine$weights>0,])$coeff[2]
unadj <- mean(combine[matches$index.treated,"RE78"]-combine[matches$index.control,"RE78"])
pred <- lm(RE78~Treated + Age + I(Age^2) + Education + Nodegree + Black + Hispanic + RE74 + RE75, data = combine, weights = combine$weights)
adj <- pred$coeff[2]
adj2 <- mean(combine[matches$index.treated,"RE78"] - (pred$fitted[matches$index.treated] - adj))
cat(c(fin[i], unadj, adj, adj2, nctrl, "\n"), sep = "\t")
}
adj
c(factor("a"), factor("b"))
